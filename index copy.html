<!DOCTYPE html>
<html>
<head>

<title>Auto Detect Route + Marker</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; }
#map { height:100vh; }
</style>

</head>

<body>

<div id="map"></div>

<script>

// ----------------------------------------------------
// CONFIG
// ----------------------------------------------------

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqYuBavhVMkzLpvOJJF8y4lPEHUoqk6QJgItUIrHBNBj5v4Cv-4DC9QN9ZrEVj6ZdlC0VF31zDfCUC/pub?output=csv";


// ----------------------------------------------------
// MAP SETUP
// ----------------------------------------------------

const usBounds = L.latLngBounds(
  [24.396308,-125.0],
  [49.384358,-66.93457]
);

const map = L.map('map', {
  maxBounds: usBounds,
  maxBoundsViscosity:1.0,
  minZoom:4
}).fitBounds(usBounds);

L.tileLayer(
 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);


// ----------------------------------------------------
// AUTO DETECT HELPERS
// ----------------------------------------------------

function findColumn(header, options) {

  for (let opt of options) {
    const idx = header.findIndex(h =>
      h.toLowerCase().includes(opt));
    if (idx !== -1) return idx;
  }
  return -1;
}

function autoLatLng(row, latIdx, lngIdx) {

  let a = parseFloat(row[latIdx]);
  let b = parseFloat(row[lngIdx]);

  if (isNaN(a) || isNaN(b)) return null;

  // auto swap if reversed
  if (Math.abs(a) > 90 && Math.abs(b) <= 90) {
    return [b,a];
  }

  return [a,b];
}


// ----------------------------------------------------
// LOAD CSV
// ----------------------------------------------------

async function loadData() {

  const res = await fetch(CSV_URL);
  const text = await res.text();

  console.log("CSV Loaded:", text);

  const lines = text.trim().split(/\r?\n/);

  const header = lines[0]
    .split(",")
    .map(v=>v.trim());

  console.log("Header:", header);

  const typeIdx = findColumn(header, ["type","kind"]);
  const latIdx  = findColumn(header, ["lat"]);
  const lngIdx  = findColumn(header, ["lng","lon","long"]);

  console.log("Detected columns:", {typeIdx,latIdx,lngIdx});

  const routeCoords = [];
  let markerLatLng = null;

  for (let i=1; i<lines.length; i++) {

    const row = lines[i]
      .split(",")
      .map(v=>v.trim());

    const coords = autoLatLng(row, latIdx, lngIdx);

    if (!coords) continue;

    const type = typeIdx !== -1
      ? row[typeIdx].toLowerCase()
      : "route";

    if (type.includes("marker")) {
      markerLatLng = coords;
    } else {
      routeCoords.push(coords);
    }
  }

  console.log("Route:", routeCoords);
  console.log("Marker:", markerLatLng);

  if (routeCoords.length) {

    const routeLine = L.polyline(routeCoords, {
      weight:4
    }).addTo(map);

    map.fitBounds(routeLine.getBounds());
  }

  if (markerLatLng) {
    L.marker(markerLatLng).addTo(map);
  }
}

loadData();

</script>

</body>
</html>